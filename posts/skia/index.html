<!DOCTYPE html>
<html lang="ko-KR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  
  <title>Skia Python 적용기</title>
  <meta property="og:title" content="Skia Python 적용기" />
  <meta name="twitter:title" content="Skia Python 적용기" />
  

  

  <meta name="author" content="김문수"/>
  <meta property="og:site_name" content="NRISE ENGINEERING BLOG" />
  <meta property="og:url" content="https://nrise.github.io/posts/skia/" />

  
  <meta name="twitter:card" content="summary" />

  

  
  <meta property="og:type" content="article" />
  
  
  
  <meta name="generator" content="Hugo 0.81.0" /><link rel="stylesheet" href="https://nrise.github.io/css/style.css" />
  
  <link rel="stylesheet" href="https://nrise.github.io/css/custom.css">
  <link rel='icon' type='image/x-icon' href="https://nrise.github.io/images/favicon.ico" />
  
  <script type="text/javascript" src="https://nrise.github.io/js/bundle.js"></script>
  
<meta name="google-site-verification" content="jmKLU_V6WMttpODvNIiwnq81HdUPIHjZfManrV3zyWU" />
<meta name="Description" content="엔라이즈 기술 블로그 NRISE ENGINEERING BLOG" />

</head>

<body>
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/ko_KR/sdk.js#xfbml=1&version=v5.0&appId=840143609777419&autoLogAppEvents=1"></script>
  <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;" aria-hidden="true"> <symbol id="icon-500px" viewBox="0 0 16 16"><g> <path d="M3.953 10.512a5.24 5.24 0 0 0 6.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122a5.226 5.226 0 0 0-2.037-.413c-.716 0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491 0-.122 0-.487-.266-.491H4.377a.343.343 0 0 0-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262 0 0 1 3.037-1.25c1.147 0 2.222.444 3.028 1.25a4.245 4.245 0 0 1 1.256 3.019 4.236 4.236 0 0 1-1.25 3.019 4.336 4.336 0 0 1-3.047 1.25 4.136 4.136 0 0 1-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09 0 0 1 1.588-.716c.594 0 1.15.225 1.566.634.409.406.637.95.637 1.528a2.179 2.179 0 0 1-2.206 2.197c-.238 0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173 0 0 0 3.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856 0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181 0 0 0 .131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088 0 .184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16 0 0 0-.113-.047c-.078 0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938 0-1.938.191-2.669.506a.207.207 0 0 0-.134.181.753.753 0 0 0 .069.337c.047.116.166.425.4.334a6.689 6.689 0 0 1 2.334-.444 6.35 6.35 0 0 1 2.469.497c.622.263 1.206.644 1.844 1.194a.22.22 0 0 0 .147.059c.125 0 .244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858 0 0 0-2.1-1.356 7.326 7.326 0 0 0-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32 0 0 1-6.938 1.356 6.336 6.336 0 0 1-2.013-1.356 6.046 6.046 0 0 1-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261 0 0 0 2.04 3.994 7.266 7.266 0 0 0 10.288 0l.059-.059c.069-.084.134-.225-.159-.516z"/> </g></symbol> <symbol id="icon-codepen" viewBox="0 0 16 16"><g> <path d="M14.777 5.751l-7-4.667a.5.5 0 0 0-.555 0l-7 4.667a.501.501 0 0 0-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5 0 0 0 .554 0l7-4.667a.501.501 0 0 0 .223-.416V6.167a.501.501 0 0 0-.223-.416zM7.5 10.232L4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0l-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5L1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2l3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5L14 7.101v2.798L11.901 8.5z"/> </g></symbol> <symbol id="icon-dribbble" viewBox="0 0 16 16"><g> <path d="M8 16c-4.412 0-8-3.588-8-8s3.587-8 8-8c4.412 0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7 0 0 1 1.328 4.872 6.845 6.845 0 0 0 2.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807 0 0 0 6.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04 0 0 1 .269-.081 24.04 24.04 0 0 0-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209 0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831a43.092 43.092 0 0 0-2.534-3.953 6.854 6.854 0 0 0-3.784 4.784zM6.4 1.366a36.612 36.612 0 0 1 2.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799 0 0 0 6.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219a6.816 6.816 0 0 0-1.544-4.256z"/> </g></symbol> <symbol id="icon-facebook" viewBox="0 0 16 16"><g> <path d="M9.5 3H12V0H9.5C7.57 0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/> </g></symbol> <symbol id="icon-feed" viewBox="0 0 16 16"><g> <path d="M2.13 11.733c-1.175 0-2.13.958-2.13 2.126 0 1.174.955 2.122 2.13 2.122a2.126 2.126 0 0 0 2.133-2.122 2.133 2.133 0 0 0-2.133-2.126zM.002 5.436v3.067c1.997 0 3.874.781 5.288 2.196a7.45 7.45 0 0 1 2.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006 0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824 0 .006 0z"/> </g></symbol> <symbol id="icon-flickr" viewBox="0 0 16 16"><g> <path d="M0 8.5a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0zm9 0a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/> </g></symbol> <symbol id="icon-github" viewBox="0 0 16 16"><g> <path d="M8 .198a8 8 0 0 0-2.529 15.591c.4.074.547-.174.547-.385 0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954 0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117 0 0 .672-.215 2.201.82A7.672 7.672 0 0 1 8 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147 0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481 0 1.07-.009 1.932-.009 2.195 0 .213.144.462.55.384A8 8 0 0 0 8.001.196z"/> </g></symbol> <symbol id="icon-gitlab" viewBox="0 0 28 28"><g> <path d="M1.625 11.031L14 26.89.437 17.046a1.092 1.092 0 0 1-.391-1.203l1.578-4.813zm7.219 0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548 0 0 1 1.031 0zm20.625 9.562l1.578 4.813a1.09 1.09 0 0 1-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548 0 0 1 1.031 0z"/> </g></symbol> <symbol id="icon-google-plus" viewBox="0 0 16 16"><g> <path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737 0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991 0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784 0 5.059 0 7.875s2.275 5.091 5.091 5.091c2.937 0 4.888-2.066 4.888-4.975 0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/> </g></symbol> <symbol id="icon-instagram" viewBox="0 0 22 22"><g> <path d="M15.445 0H6.554A6.559 6.559 0 0 0 0 6.554v8.891A6.559 6.559 0 0 0 6.554 22h8.891a6.56 6.56 0 0 0 6.554-6.555V6.554A6.557 6.557 0 0 0 15.445 0zm4.342 15.445a4.343 4.343 0 0 1-4.342 4.342H6.554a4.341 4.341 0 0 1-4.341-4.342V6.554a4.34 4.34 0 0 1 4.341-4.341h8.891a4.342 4.342 0 0 1 4.341 4.341l.001 8.891z"/> <path d="M11 5.312A5.693 5.693 0 0 0 5.312 11 5.694 5.694 0 0 0 11 16.688 5.694 5.694 0 0 0 16.688 11 5.693 5.693 0 0 0 11 5.312zm0 9.163a3.475 3.475 0 1 1-.001-6.95 3.475 3.475 0 0 1 .001 6.95zm5.7-10.484a1.363 1.363 0 1 1-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/> </g></symbol> <symbol id="icon-linkedin" viewBox="0 0 16 16"><g> <path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502 0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5a1.5 1.5 0 1 1-3.001-.001A1.5 1.5 0 0 1 4 3.5z"/> </g></symbol> <symbol id="icon-mail" viewBox="0 0 22 18"><g> <path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275l5.077-5.09L1.795 3.98v10.155zm13.332-5.09l5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588l8.022-8.027-16.045-.001 8.023 8.028z"/> </g></symbol> <symbol id="icon-medium" viewBox="0 0 24 24"><g> <path d="M22.085 4.733L24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244 0 0 1-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287 0 .346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556 0 0 1-.214-.534V5.267a.554.554 0 0 1 .213-.534z"/> </g></symbol> <symbol id="icon-npm" viewBox="0 0 16 16"><g> <path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/> </g></symbol> <symbol id="icon-pinterest" viewBox="0 0 16 16"><g> <path d="M8 1.069a6.93 6.93 0 0 0-2.525 13.384c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591 0 .878.444.878.975 0 .594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231 0 2.178-1.3 2.178-3.175 0-1.659-1.194-2.819-2.894-2.819-1.972 0-3.128 1.478-3.128 3.009 0 .597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89 0 0 1-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684 0-2.188 1.587-4.194 4.578-4.194 2.403 0 4.272 1.712 4.272 4.003 0 2.388-1.506 4.313-3.597 4.313-.703 0-1.362-.366-1.588-.797 0 0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93 0 0 0 8.984-6.622 6.931 6.931 0 0 0-6.931-6.934z"/> </g></symbol> <symbol id="icon-search" viewBox="0 0 16 16"><g> <path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 1 0-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/> </g></symbol> <symbol id="icon-tumblr" viewBox="0 0 16 16"><g> <path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81 0 1.289-.107 2.09-.633v2.405a9.089 9.089 0 0 1-1.833.639A7.93 7.93 0 0 1 9.369 16a4.9 4.9 0 0 1-1.725-.276 4.195 4.195 0 0 1-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386 0 0 0 1.08-1.374C6.133 1.505 6.32.825 6.422 0h2.579v4H13v3H9.001z"/> </g></symbol> <symbol id="icon-twitter" viewBox="0 0 16 16"><g> <path d="M16 3.538a6.461 6.461 0 0 1-1.884.516 3.301 3.301 0 0 0 1.444-1.816 6.607 6.607 0 0 1-2.084.797 3.28 3.28 0 0 0-2.397-1.034 3.28 3.28 0 0 0-3.197 4.028 9.321 9.321 0 0 1-6.766-3.431 3.284 3.284 0 0 0 1.015 4.381A3.301 3.301 0 0 1 .643 6.57v.041A3.283 3.283 0 0 0 3.277 9.83a3.291 3.291 0 0 1-1.485.057 3.293 3.293 0 0 0 3.066 2.281 6.586 6.586 0 0 1-4.862 1.359 9.286 9.286 0 0 0 5.034 1.475c6.037 0 9.341-5.003 9.341-9.341 0-.144-.003-.284-.009-.425a6.59 6.59 0 0 0 1.637-1.697z"/> </g></symbol> <symbol id="icon-vimeo" viewBox="0 0 16 16"><g> <path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931 0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119 0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334 0 .838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98 0 0 0-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/> </g></symbol> <symbol id="icon-wordpress" viewBox="0 0 16 16"><g> <path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693 0 0 0 2 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371 0-.537.418-1.037 1.008-1.037.027 0 .052.003.078.005A6.064 6.064 0 0 0 8 2.156 6.036 6.036 0 0 0 2.987 4.79c.141.004.274.007.386.007.627 0 1.599-.074 1.599-.074.323-.018.361.444.038.482 0 0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304 0 0 1-.629-.055c-.323-.019-.285-.5.038-.482 0 0 .991.074 1.58.074.627 0 1.599-.074 1.599-.074.323-.018.362.444.038.482 0 0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806l-1.8 5.095a6.148 6.148 0 0 0 3.687-.093.52.52 0 0 1-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601 0 .593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697 0 0 0-.735-2.803zM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/> </g></symbol> <symbol id="icon-youtube" viewBox="0 0 16 16"><g> <path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359 0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/> </g></symbol></svg>
  <header class="l-header contents">
    
    <div class="c-title p-title logo-title">
      <a href="https://nrise.github.io/" class="p-title__link logo-link">
        <img src="https://nrise.github.io/images/logo_new.png" alt="logo" class="logo-image" />
        <span class="logo-title-text">기술 블로그</span>
      </a>
      <nav class="top-menu">
        <a class="top-menu-item" href="https://nrise.net/" target="_blank" rel="noreferrer">
          About
        </a>
        <a class="top-menu-item" href="https://www.wanted.co.kr/company/5005" target="_blank" rel="noreferrer">
          Career
        </a>
      </nav>
    </div>

    
    
  </header>
  <main id="main" class="l-main">


<article class="p-article">
  <header>
    <h1>Skia Python 적용기</h1>
    <div>
      <div class="c-time">
        <time datetime="2016-07-01T00:00:00Z">
          Jul 1, 2016
        </time>
        <span class="list-author">김문수</span>
        <img src="/images/profile/moonsoo.kim.png" alt="profile" class="profile-image" />
      </div>
      
    </div>
  </header>
  
  <section id="js-article" class="p-article__body">
    <h2 id="skia-와의-첫-만남">Skia 와의 첫 만남</h2>
<p><a href="/posts/stack-of-moci/">모씨 서버 아키텍쳐</a>는 기본적으로 Python + Flask 로 구성되어 있으며,
그 중 카드 생성 프로세스는 Celery 와 ImageMagick + Wand 로 구성되어 있습니다.</p>
<p>모씨를 방문하는 이용자들은 매일 수 백만장의 카드를 업로드 합니다.
실제 모씨가 오픈한 2014년 11월 이후 약 1년 6개월이 넘는 동안
이용자들이 업로드한 카드는 약 4억장에 이릅니다. 이용자들간의 주요
소통 수단이 카드인 만큼 카드 업로드 관련 코드는 꽤나
중요한 부분입니다만 별 탈 없이 안정적으로 운용되어 왔기에
크게 개선의 필요성을 느끼지 못하고 있던 상황이었습니다.</p>
<p>그러던 중 5월 중순에 <a href="http://engineering.vcnc.co.kr/2016/05/ondemand-image-resizing/">VCNC 엔지니어링 블로그에 올라온 글</a>
을 보게 되었습니다. 비트윈 아키텍쳐에 <a href="https://skia.org/">Skia</a>
를 적용하며 4배 정도의 성능 개선을 이루었다는 말에 굉장히 큰
자극을 받고 모씨 아키텍쳐에도 적용하면 좋겠다&hellip;라는 생각을
하게 되었습니다. 하지만 당시 모씨 클라이언트에 굉장히 큰 기능
추가가 있었던 관계로 칸반 보드에 관련 이슈를 붙여놓기만
하고 후일을 기약하기로 했습니다.</p>
<p>시간이 지나고 어느 정도 중요한 작업들을 끝낸 후에 약 1주일
정도 Skia 를 적용할 수 있는 시간을 확보할 수 있었고,
작업을 시작하기로 하였습니다.</p>
<h2 id="작업-시작-이름-짓기">작업 시작, 이름 짓기</h2>
<p>실제로 Skia 적용 작업을 하기 전에 틈틈이 Skia 관련된 자료들을
찾아보고, C++ 프로젝트를 Python 으로 쉽게 바인딩 할 수
있는 방법들에 대한 조사를 진행했습니다. 그리고 작업을 시작하기
전 다음과 같은 규칙을 정했습니다.</p>
<ul>
<li>Skia 는 문서가 상대적으로 빈약한 관계로, 1주일 안에 완성하지 못할 경우 프로젝트를 포기한다.</li>
<li>Python - C++ 바인딩을 해 본 경험이 없으므로 마찬가지로 1주일 안에 완성하지 못할 경우 프로젝트를 포기한다.</li>
<li>꽤나 어려운 작업이 될 것 같으므로 작업이 완료되면 코드를 공개한다.</li>
</ul>
<p>진행하기로 결정한 만큼 무엇보다 먼저 프로젝트의 이름을 지어야 했습니다.
잠깐 생각한 후 프로젝트 이름을 다음 두 가지로 압축 하였습니다.</p>
<ul>
<li><strong>SIPSkia</strong> - Simple Image Processing by Skia</li>
<li><strong>GAESkia</strong> - Graphic Analyzing Engine by Skia</li>
</ul>
<p>후보군을 정하고 다음날 오전 스탠드 미팅 때 모씨 팀원들의 의견을
물어보았는데 호불호가 적당히 반반인 것 같아서 <strong>SIPSkia</strong> 로 그냥 제가 정했습니다.</p>
<h2 id="클론-테스트">클론, 테스트</h2>
<p>Skia 소스코드를 먼저 다운 받아서 빌드를 진행해 보았습니다.
제가 경험한 빌드 툴은 make/cmake 정도인데 난생 처음보는
<a href="https://gyp.gsrc.io/">gyp</a> 와 <a href="https://ninja-build.org/">ninja</a>
가 등장하니 정말 시작부터 정신을 못차리겠더군요. 궁금한
부분들은 덮어두고 일단 xcode 빌드와 커맨드라인 빌드를 번갈아
하면서 Skia 프로젝트 자체에 익숙해지려는 시도를 계속 했습니다.
한 두시간 코드를 노려보고 있으니 조금씩 구성이나 상황이 눈에
익기 시작했습니다. 시작이 반이라는데 참 다행이라는 생각이 들더군요.</p>
<p>일단 SampleApp 이라는 프로젝트를 실행해 테스트 해 보면서 예제
중 하나를 골라 그곳에 코드를 심어 테스트를 시작했습니다.
간단하게는 로컬 이미지 파일 로딩 부터 시작하여 필요로 하는
crop, resize 테스트를 금방 해 볼 수 있었습니다. 문제는 그 뒤에 일어났습니다.</p>
<p>마지막으로 변환된 이미지를 jpeg 으로 인코딩 해야 하는데 아무리
코드를 실행해도 제대로 수행이 되지 않는 상황을 마주하게 되었습니다.
디버깅을 진행해도 문제점을 몰라서 이틀 정도 고생을 했는데요,
Skia 프로젝트는 master 브랜치를 develop 브랜치로 이용하고 있다는
사실을 뒤늦게 알게 됩니다;; git-flow 브랜치 모델에 익숙해져
있는 상황에서 master 가 당연히 최신 릴리즈겠거니 생각한 저의 실수였습니다.
chrome/m52 릴리즈(당시 가장 최신) 로 체크아웃 하여 빌드한 후
jpeg 인코딩이 무리없이 진행되는 것을 확인하였습니다.</p>
<p>당연한 것이긴 하지만 제가 필요로 하는 기능들을 직접 수행해 보았으니
본격적인 작업에 들어가게 됩니다.</p>
<h2 id="모씨-서버에-맞도록">모씨 서버에 맞도록</h2>
<p>하지만 1주일의 시간 안에 잘 정의된 문서 없이 40만 라인이 넘는 Skia 코드를
분석한 후 관련 코드 작성 방법이나 룰을 파악하는 것은 불가능합니다.
두서 없이 코드를 계속 보다가 skhello.cpp 파일을 발견하고 해당 코드를
기반으로 sipskia 개발을 진행하기로 결정 하였습니다. 간단하게
API 인터페이스를 명세한 후 코드 작성을 진행 하였습니다.
앞서 워낙 삽을 많이 떠서 그런지 이 부분은 크게 어려운 점이
없이 수월하게 진행이 완료 되었습니다. 어느 정도 API 인터페이스가
나온 후에 boost-Python 을 통한 Python 바인딩 작업으로 넘어가게 됩니다.</p>
<h2 id="boost-python-distutils">boost-Python, distutils</h2>
<p>흔히들 Python 은 C 와의 접착성이 매우 좋다고들 합니다.
그런데 C++ 라이브러리를 Python 에 붙이는 것은 생각보다
쉽지 않은 것 같더군요. 조사해 보니 많은 대안 중에 <a href="http://www.boost.org/libs/python/doc/">boost-Python</a>
을 확인할 수 있었고 잘 모르는 저는 그냥 덥썩 사용하기로
결정 하였습니다. 그와 동시에 distutils 를 이용해서 손쉽게
Python 라이브러리를 만드는 것도 같이 조사해야 했습니다.</p>
<p>API 구조 자체가 복잡하지 않아서(C like) boost-Python 을
적용하는 것은 크게 문제가 되지 않았습니다. 다만 jpeg
바이너리의 경우 바이너리 스트림 중간에 &lsquo;\0&rsquo; 문자가
포함되는 경우가 있는데 이를 무시하는 전체 데이터를 PyObject
형태로 넘기는 부분에서 조금 헤맸습니다만 다행히 Python
공식 문서를 보고 해결할 수 있었습니다.</p>
<p>가장 큰 문제는 distutils 를 이용한 cpp 코드 빌드였는데요,
일단 skhello 자체가 ninja 를 통해 빌드되다 보니 빌드
옵션을 전혀 모른다는 문제가 있었습니다. 그렇다고 gyp
가 생성한 Makefile 을 볼 생각은 죽어도 없고 그냥 xcode
를 통한 빌드 메시지를 확인해서 한 줄 한 줄 분석하여
그대로 setup.py 에 때려박아 버렸습니다. 문제는 계속 이어졌는데요,
setup.py 를 통한 빌드 시에 정의하지 않은 컴파일 옵션이 계속
붙어다녀서 확인해 보니 distutils 의 버그 아닌 버그라는
것을 웹과 distutils 코드 리뷰를 통해 확인할 수 있었습니다.
약간의 trick 을 써서 컴파일 옵션을 커스터마이징 하였고 빌드에
성공 하였습니다.</p>
<p>마지막으로 릴리즈 빌드 옵션까지 모두 확인한 후에 릴리즈
모드로 빌드 후 최종적으로 sipskia.so 파일을 얻어내는데 성공하였습니다.</p>
<h2 id="성능-테스트">성능 테스트</h2>
<p>가장 두근거리는 순간이었습니다. ImageMagick 에 비해 얼마나
성능 개선이 있을까? 모씨 이미지 사이즈가 크지 않아서 성능
차이가 없으면 어쩔까? 여러 걱정을 하면서 테스트를 진행
하였는데, 평균 약 4배, 빠를 때는 5배 이상의 성능 차이가
나는 것을 확인할 수 있었습니다.</p>
<p>다음은 메모리 누수 테스트였습니다. objective-C 조차 몇 년
전에 ARC 가 적용된 만큼 회사에서 사용하는 언어들은 모두
managed 언어인 관계로 제가 작성한 코드에 대한 검증을 진행해야
했습니다. 무한 루프로 이미지 변환 작업을 반복시키며 프로세스의
메모리 점유율을 확인하니 역시 메모리가 미친듯이 새어나가더군요.
기분좋게 메모리 누수를 모두 잡고 개발의 8부 능선을 돌파하는데 성공했습니다.</p>
<h2 id="이미지-최적화">이미지 최적화</h2>
<p>다만 금방 해결할 수 있을 줄 알았던 이미지 최적화 문제가
마지막에 발목을 잡았습니다. SkPaint 에 안티 얼라이싱
옵션을 줘도 실제 이미지에 적용이 되지 않는 문제였습니다.
관련된 문서도 전무한 상황이라 상당히 골치아픈 문제였는데
인터넷 어딘가에 굴러다니는 아주 예전 Skia 코드에서 단서를 얻어
imageFilterQuality 를 조정하는 것으로 문제를 겨우 해결할 수 있었습니다.</p>
<p>이때 사실 심적으로 굉장히 쫓기고 있었던 시점이었습니다.
스스로 약속한 1주일이 되었기 때문입니다. 당시 수요일이었고,
일단 8부 능선을 넘었다고 판단한 만큼 금요일까지 2일만 더
작업을 진행해 보고 마무리 되지 않으면 드랍하기로 결정 하였습니다.</p>
<h2 id="포팅-마지막-난관">포팅, 마지막 난관</h2>
<p>대부분의 작업이 완료되었으니 우분투로의 포팅은 단지 시간의
문제라고만 생각했습니다만 꼬박 하루가 걸렸습니다. Skia 는
기본적으로 -fPIC 옵션으로 빌드가 되지 않은데 gyp 와 ninja
기반의 빌드 환경이다 보니 -fPIC 옵션을 어디서 쑤셔 넣어야
할 지 도무지 짐작도 가지 않는 상황이었습니다. 반쯤 의심하며 해
본 GYP_DEFINES=&ldquo;skia_shared_lib=1&rdquo; 옵션을 통해 겨우
-fPIE 옵션으로 Skia 를 빌드하는데 성공했으며, boost-Python
도 마찬가지로 힘들게 -fPIC 옵션을 주고 빌드할 수 있었습니다.</p>
<p>마지막으로 오브젝트 파일들을 링크해서 생성한 sipskia.so 파일을
여는데 Bad Value 가 계속 발생할 때는 정말 다 집어치우고 싶었습니다만
어찌어찌 빌드를 마무리 할 수 있었습니다. 거기에 맞추어
setup.py 역시 변경 작업을 마무리 하였습니다.</p>
<p>그 외에 CPU 바이트 오더와 관련된 Skia 의 버그가 하나 있었는데
이 부분까지 설명하자면 너무 길어지므로 생략하겠습니다&hellip;.</p>
<h2 id="최종-테스트-그리고-배포">최종 테스트, 그리고 배포</h2>
<p>모씨 서버의 celery 코드에 sipskia 관련 코드를 머징하는 작업을
진행하는 것으로 모두 마무리 되었습니다. 최종적으로 목요일
저녁에 모든 작업이 끝났으며, 금요일에 오후에 성공적으로 서버에
배포 하였습니다.</p>
<p>카드 변환-업로드 루틴에서 변환이 차지하는 성능 비중은 약 10%
에 불과하기 때문에 4배의 성능 향상이 있다 하더라도 이게 전체
업로드 퍼포먼스에는 큰 영향을 끼치진 못합니다. 다만 놀라운 것은
이미지 변환 서버의 CPU 사용률 변화입니다. 기존 이미지 변환 서버
대비 약 30 ~ 40%  의 CPU 사용률 감소가 있었습니다.
이 효율이 그대로 비용절감으로 이어진다는 것을 생각한다면 꽤나
놀라운 수치라고 볼 수 있습니다. 다음은 Newrelic 에서 캡쳐한
각각 ImageMagick/Skia 가 적용된 서버들의 CPU 사용률입니다.</p>
<p>ImageMagick 기반 서버의 CPU 사용률
<img src="/images/20160701/old.jpg" alt=""></p>
<p>Skia 기반 서버의 CPU 사용률
<img src="/images/20160701/new.jpg" alt=""></p>
<p>전체적으로 Skia 가 적용된 서버가 훨씬 여유있는 모습을 보여주고 있습니다.</p>
<h2 id="회고-오픈-소스">회고, 오픈 소스</h2>
<p>Skia 라이브러리의 놀라운 성능은 CPU 인스트럭션 수준에서의 최적화에
기인합니다. 실제로 Skia 코드를 조금 뜯어보면 어셈블리 코드를 굉장히
많이 발견할 수 있습니다. 개인적으로 시간에 여유가 좀 더 있었다면
더욱 완성도 있는 라이브러리를 만들 수 있지 않았나 생각해 봅니다만
우선 이 정도에도 만족하고 있습니다. 앞으로도 지속적인 성능
개량을 해 나가고자 합니다.</p>
<p>본 프로젝트를 진행하며 참고 문서가 부족하여 벽에 부딪힐 때
마다 새삼 그 동안 이름도 얼굴도 모르는 수 많은 개발자들에게
기대어 개발을 해 왔다는 생각을 하곤 했습니다. 그리고 이번
프로젝트의 결과물이 아무리 하찮고 볼 것 없더라도 코드를
공개하여 혹시 모를 사람에게 도움이 되었으면 하는 마음을
가지게 되었습니다. Skia 에 관심을 가지고 있는 개발자들이라면
이 글과 소스코드가 조금이라도 도움이 되었으면 합니다.</p>
<p>아래 링크를 통해 소스코드를 확인할 수 있습니다.</p>
<p><strong><a href="https://github.com/nrise/sipskia/">SIPSkia : Simple Image Processing by Skia</a></strong></p>
<p>문의 사항이 있으면 moonsoo.kim at nrise.net 으로 메일 주세요.</p>
<h2 id="참고">참고</h2>
<ul>
<li>Skia : <a href="https://skia.org">https://skia.org</a></li>
<li>boost : <a href="http://www.boost.org">http://www.boost.org</a></li>
<li>Wand : <a href="http://docs.wand-py.org">http://docs.wand-py.org</a></li>
<li>VCNC Engineering Blog : <a href="http://engineering.vcnc.co.kr/2016/05/ondemand-image-resizing">서버 비용을 70%나 줄인 온디맨드 리사이징 이야기</a></li>
<li>모씨 개발 수첩 : <a href="/posts/stack-of-moci/">모씨 서버 아키텍쳐</a></li>
</ul>

	<div class="fb-comments" data-href="https://nrise.github.io/posts/skia/" data-width="100%" data-numposts="10"></div>
  </section>
  <footer>
    
    <nav class="p-pagination c-pagination">
      <div class="c-pagination__ctrl">
        <div class="c-pagination__newer">
          
          <a href="https://nrise.github.io/posts/upgrade-database/">Newer</a>
          
        </div>
        <div class="c-pagination__older">
          
          <a href="https://nrise.github.io/posts/stack-of-moci/">Older</a>
          
        </div>
      </div>
    </nav>
    


    
<aside class="p-author">
  
  
  <div class="p-author__body">
    
    <p class="c-title p-author__name ">김문수</p>
    
    
    
  </div>
  
</aside>


  </footer>
</article>
  </main>
  

  <footer class="l-footer">
    
<ul class="c-links">
  
  
  
  
  
  
  <li class="c-links__item">
    <a href="https://github.com/nrise" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>github</title>
        <use xlink:href="#icon-github"></use>
      </svg>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
</ul>



    <p class="p-copyright">
	Powered by <a href="https://gohugo.io/">hugo</a>.<br />
	
        &copy; Copyright 2011-2021 NRISE, Inc. All rights reserved.
      
    </p>
  </footer>

  
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-56246190-2', 'auto');
      ga('send', 'pageview');
    </script>
    
  

</body>
</html>

